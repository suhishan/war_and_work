---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(sf)
library(tidyverse)
library(xtable)
library(tidybayes)
library(patchwork)

theme_set(theme_minimal()+
            theme(panel.grid = element_blank()))
```

## 1. Read district names and geo-spatial information from the shape file.

```{r}
districts <- st_read("Data/Nepal Shapfiles GADM/gadm36_NPL_3.shp")

```

## 2.Merging.

```{r}
districts <- districts %>% mutate(
  district_abbrev = case_when(
    NAME_3 == "Parvat"~ "parb",
    NAME_3 == "Dhankuta" ~ "dhak",
    TRUE ~ str_sub(str_to_lower(NAME_3),1, 4))
)


districts_joined <- inner_join(districts, c_small,
                              by = c("district_abbrev"))
```

## 3. Make the map using ggplot.

```{r}
# Convert a regular dataframe object into an sf object.

districts_joined <- districts_joined %>% mutate(
  treatment_s = factor(treatment_s,
                       labels = c("Low Conflict Intensity",
                                  "High Conflict Intensity"))
)

p1 <- districts_joined %>% 
  ggplot()+
  geom_sf(aes(fill = treatment_s), color = "black", size = 0.2)+
  scale_fill_manual(
    values = c("Low Conflict Intensity" = "lightpink",
               "High Conflict Intensity" = "darkred"),
    name = "Treatment"
  )+
  geom_sf_text(aes(label = as.character(best_est)), size = 2)+
  theme_minimal()
  

p1
```

# A new idea.

I want to see whether there are significant differences in the death rates between adjacent districts, and whether that can be leveraged.

Assumption:

1.  If there indeed are two neighbouring districts with one that has experienced high conflict intensity and one that has experienced low conflict intensity, it may be the case that these districts are balanced on observables.

Merge geospatial district data with all of conflict data i.e. let's see the map for all districts.

```{r}
dj <- inner_join(districts, c_collapsed_2, by = c("district_abbrev"))

dj$cd_per_10000 <- round( (dj$best_est/dj$popn_2001) * 1e4, 3)
```

## Drawing the map with conflict deaths.

```{r}
# With district and conflict deaths per 10,000 people

dj %>% 
  mutate(label = paste0(district_name,"\n", cd_per_10000)) %>% 
  ggplot()+
  geom_sf(fill = "white", color = "black")+
  geom_sf_text(aes(label = label), size = 3)

# With only conflict deaths per 10,000 people and overall conflict deaths.

dj %>% 
  mutate(label = paste0(best_est, "\n", cd_per_10000)) %>% 
  ggplot()+
  geom_sf(fill = "white", color = "black")+
  geom_sf_text(aes(label = label), size = 2.5)

# Seeing the difference between deaths_until_98 and total deaths.

dj %>% 
  mutate(label = paste0(deaths_until_98,"\n", cd_per_10000, "\n", best_est,
                        "\n", district_abbrev)) %>%
  ggplot()+
  geom_sf(fill = "white", color = "black")+
  geom_sf_text(aes(label = label), size = 2)+
  theme_minimal()

# Civilian Deaths.

dj %>% 
  mutate(label = deaths_civilians) %>%
  ggplot()+
  geom_sf(fill = "white", color = "black")+
  geom_sf_text(aes(label = label), size = 2)



```

Some clear differences in adjacent districts are:

1.  Rukum and Rolpa vs. Pyuthan (and Baglung)
2.  Dang and Salyan.
3.  Bhojpur and Dhankuta.
4.  Siraha and Saptari

Clear Differences when deaths_until_98 is 0 or very small.

1. Gulmi (0 to 57(1.92)) and Arghakhanchi (0 to 244(11.7))
2. Myagdi (0 to 254 (22.2)) and Kaski (0 to 93 (2.4))
3. Myagdi (0 to 254 (22.2)) and Baglung (1 to 108 (4.016))
4. Tanahu(2 to (2.98)) and Lamjung (2 to 14.451)
  
## Rukum, Rolpa, Pyuthan and Baglung only dataset.

```{r}
c_merged_all <- left_join(nlfs, c_collapsed_2, 
                          by = c("district_abbrev"))

# Rukum Rolpa Pyuthan Baglung.
c_merged_1 <- c_merged_all %>% filter(
  district_abbrev %in% c("ruku","rolp", "pyut", "bagl")
)

#Tanahu and Lamjung
c_merged_2 <- c_merged_all %>% filter(
  district_abbrev %in% c("tana", "lamj")
) 

#Gulmi and Arghakhanchi

c_merged_3 <- c_merged_all %>% filter(
  district_abbrev %in% c("gulm", "argh")
)
```


## Let's go with Gulmi and Arghakhanchi.

### Sample Sizes table.

```{r}
c_merged_3 %>% count(nlfs_year, distname)



# What proportion of people surveyed in 2008 were permanent residents and did not move to the place due to the conflict?
c_merged_3 %>% filter(nlfs_year == 2008) %>% 
  group_by(distname) %>% summarize(mean(perma_resident))

# Assigning Treatment and Control.
c_merged_3 <- c_merged_3 %>% mutate(
  treatment_s = ifelse(district_abbrev == "argh", 1, 0),
  post = ifelse(nlfs_year == 2008, 1, 0),
  cd_per_10000 = (best_est/popn_2001) * 10000
)

# Only for 1998 (post = 0)
c_merged_3_98 <- c_merged_3 %>% filter(post == 0)

# Deaths difference
c_merged_3 %>% group_by(post, treatment_s) %>% 
  summarize(mean(cd_per_10000), mean(deaths_until_98))

```

### Covariate Balance and normalized difference

Are these two districts indeed balanced on covariates in 1998?

```{r}
#function to calculate normalized difference

norm_difference <- function(t, x) {
  mean_t <-  mean(x[t == 1], na.rm = T)
  mean_c <-  mean(x[t == 0], na.rm = T)
  sd_t <-  sd(x[t == 1],na.rm =T)
  sd_c <- sd(x[t==0],na.rm = T )
  norm_diff = (mean_t - mean_c) / sqrt(0.5 * (sd_t^2 + sd_c^2))
  return (round(norm_diff, digits = 4))
}

table_norm <- c_merged_3_98 %>% 
  select(age, years_of_edu_all, years_of_edu, hindu,
         brahmin_chhetri, sex, marital_status,
         treatment_s, hhsize, urbrur,
         ever_school) %>% 
  summarize(across(
    .cols = -treatment_s,
    .fns = list(
      norm_diff = ~norm_difference(treatment_s, .x),
      mean_t  = ~ mean(.x[treatment_s == 1], na.rm = T),
      mean_c = ~mean(.x[treatment_s == 0], na.rm = T)),
    .names = "{fn}_{.col}"
  )) %>% 
 pivot_longer(
    cols = everything(),
    names_to = "stat_var", values_to = "value"
  ) %>% 
  extract(stat_var, into = c("stat", "variable"),
          regex = "(norm_diff|mean_t|mean_c)_(.+)") %>% 
  pivot_wider(
    names_from = stat, values_from = value
  )


```

Output the table.

```{r}
pretty_names <- c(
  age = "Age",
  years_of_edu_all = "Years of Education (All)",
  years_of_edu = "Years of Education (If attended school)",
  hindu = "Hindu (1/0)",
  brahmin_chhetri = "Brahmin/Chhetri(1/0)",
  sex = "Male",
  marital_status = "Married",
  hhsize = "Household Size",
  urbrur = "Urban",
  ever_school = "Ever Attended School"
)

table_norm_out <- table_norm %>% 
  mutate(
    variable = pretty_names[variable]
  ) %>% 
  rename(
    `Norm. Diff` = norm_diff,
    `Treated Mean` = mean_t,
    `Control Mean` = mean_c,
  ) %>% mutate(
    across(c(`Norm. Diff`, `Treated Mean`, `Control Mean`), ~ round(.x, 3))
  ) %>% 
  column_to_rownames("variable")

print(xtable(table_norm_out, caption = "Covariate Balance Statistics"), 
      type = "latex",
      file = "Analysis files/covariate_balance_3.tex",
      booktabs = T,
      )

```

### Covariate Balance in Trends.

```{r}
t1 <- c_merged_3 %>% 
  select(age, years_of_edu_all, years_of_edu, hindu,
         brahmin_chhetri, sex, marital_status,
         treatment_s, hhsize,post, urbrur,
         ever_school) %>% 
  group_by(treatment_s) %>% 
  summarize(
    across(
      .cols = -post,
      .fns = list(
        delta = ~ mean(.x[post == 1], na.rm = T) - mean(.x[post == 0], 
                                                        na.rm = T)),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop") %>% 
    pivot_longer(cols = -treatment_s, names_to = "variables",
                 values_to = "delta") %>% 
  pivot_wider(names_from = treatment_s, values_from = delta,
              names_prefix = "delta_")


```

Output the Covariate Balance in Trends:

```{r}
pretty_names_delta <- c(
  age_delta = "Age",
  years_of_edu_all_delta = "Years of Education (All)",
  years_of_edu_delta = "Years of Education (If attended school)",
  hindu_delta = "Hindu (1/0)",
  brahmin_chhetri_delta = "Brahmin/Chhetri(1/0)",
  sex_delta = "Male",
  marital_status_delta = "Married",
  hhsize_delta = "Household Size",
  urbrur_delta = "Urban",
  ever_school_delta = "Ever Attended School"
)

t1_out <- t1 %>% 
  mutate(variables = pretty_names_delta[variables]) %>% 
  rename(
    `Control trend` = delta_0,
    `Treatment trend` = delta_1,
  ) %>% column_to_rownames("variables") %>% 
  mutate(
    across(c(`Control trend`,`Treatment trend`), ~ round(.x, 3) )
  )


print(xtable(t1_out, caption = "Covariate Balance Statistics for trends/differences (2008 - 1998)"), 
      type = "latex",
      file = "Analysis files/covariate_balance_trends_3.tex",
      booktabs = T,
      )
t1_out

```

### Let's try and model usually employed.

Normal intercept-only model.

Group
1  = 1998 Gulmi
2 = 2008 Gulmi
3 = 1998 Arghakhanchi
4 = 2008 Arghakhanchi

Death Difference: 1.92 and 11.7 in 2008.
In 1998, both are 0 or close to 0. 

```{r}
c_merged_3 <- c_merged_3 %>% mutate(
  group = factor(1 + post + 2 * treatment_s)
)

map1.1 <- brm(
  data = c_merged_3,
  family = bernoulli,
  usually_emp ~ 1,
  prior = c(
    prior(normal(2, 1), class = Intercept)
  ),
  iter = 2e3, warmup = 1e3, chains = 4, cores = 4,
  file = "fits/map1.1"
)
```

Model with predictors.

```{r}
map1.2 <- brm(
  data = c_merged_3,
  family = bernoulli,
  usually_emp ~ 0 + group,
  prior = c(
    prior(normal(1, 1), class = b)
  ),
  iter = 2e3, warmup = 1e3, chains = 4, cores = 4,
  file = "fits/map1.2"
)

```


Let's see what the DiD estimate looks like:

```{r}
post_1.2 <- as_draws_df(map1.2) %>%
  mutate(did_est_r = (b_group4 - b_group2) - (b_group3 - b_group1)) %>%
  mutate(
    # absolute scale.
    did_est_a = (inv_logit_scaled(b_group4) - inv_logit_scaled(b_group2)) -
      (inv_logit_scaled(b_group3) - inv_logit_scaled(b_group1))
    ) %>% 
  data.frame()

post_1.2 %>% mean_qi(did_est_a, .width = .89)

post_1.2 %>% 
  ggplot(aes(x = did_est_a ))+
  geom_density(fill = "skyblue", alpha = 1/2)+
  labs(title = "DiD Estimate (in absolute scale) on the 
       probability of being usually employed",
       x = "Did Estimate")+
  theme_minimal()

```

For Hours Worked, some of the distributions that can be used are:

1. Zero-inflated Poisson Regression.
3. Hurdle Log-Normal Distribution
4. Zero-inflated Binomial Distribution.

### Zero-inflated Binomial.

Intercept only model.

```{r}
map_1.3 <- brm(
  data = c_merged_3,
  family = binomial,
  work_hours_outside | trials(84) ~ 1,
  prior = c(
    prior(normal(0, 1.5), class = Intercept)
  ),
  
  iter = 2000, warmup = 1000, chains = 4, cores = 4,
  file = "fits/map1.3"
)
```

Group-wise Model.

```{r}
map_1.4 <- brm(
  data = c_merged_3,
  family = binomial,
  work_hours_outside | trials(84) ~ 0 + group,
  prior = c(
    prior(normal(0, 1.5), class = b)
  ),
  
  iter = 2000, warmup = 1000, chains = 4, cores = 4,
  file = "fits/map1.4"
)

```

### Hurdled Log-normal model.

```{r}
c_merged_3 <- c_merged_3 %>% mutate(
  wh = ifelse(work_hours_outside == 0, 0, work_hours_outside),
  log_wh = log1p(work_hours_outside),
  is_zero = work_hours_outside == 0
)
```

#### Output a histogram of workhours outside to show why we need a hurdled log normal model.

```{r}
wh_hist <- c_merged_3 %>% 
  ggplot(aes(wh))+
  geom_histogram(aes(fill = is_zero),binwidth = 1.5)+
  scale_fill_manual(values = c("TRUE" = "skyblue", "FALSE" = "red"),
                    name = "Is Zero")+
  labs(x = "Work Hours", y = "Frequency",
       title = "Work Hours Histogram")+
  theme(legend.position = "bottom")

log_wh_hist <- c_merged_3 %>% 
  ggplot(aes(log_wh))+
  geom_histogram(aes(fill = is_zero), binwidth = 0.08)+
  scale_fill_manual(values = c("TRUE" = "skyblue", "FALSE" = "red"),
                    name = "Is Zero")+
  labs(x = "Work Hours", y = "Frequency",
       title = "Log Work Hours Histogram")+
  theme(legend.position = "bottom")

plot_hist <- (wh_hist | log_wh_hist)

ggsave("Analysis files/wh_histogram.jpg", plot = plot_hist,
       width = 40, height = 20, units = c("cm"), bg = "white")
```


Model 1 : Intercept only model:

```{r}
model_log_1 <- brm(
  data = c_merged_3,
  family = hurdle_lognormal,
  bf( wh ~ 1,
      hu ~ 1),
  prior = c(
    prior(lognormal(3, 0.5), class = Intercept, lb = 0),
    prior(normal(0, 1), dpar = "hu", class = Intercept)
  ),
  iter = 2000, warmup = 1000, chains = 4, cores = 4,
  file = "fits/model_log_1"
)

```

Model 2 : Model with groups:

```{r}
model_log_2 <- brm(
  data = c_merged_3,
  family = hurdle_lognormal,
  bf(wh ~ 0 + group,
      hu ~ 0 + group),
  prior = c(
    prior(lognormal(3, 0.5), class = b, lb = 0),
    prior(normal(0, 1), dpar = "hu", class = b)
  ),
  iter = 2000, warmup = 1000, chains = 4, cores = 4,
  file = "fits/model_log_2"
)

```

#### Coefficient Plots and overall DiD contrast for model 2

```{r}
names <- c("1998 Gulmi", "2008 Gulmi", "1998 Arghakhanchi", "2008 Arghakhanchi")

post_log_2 <- as_draws_df(model_log_2) %>% 
  data.frame()

# Coefficient Plot.

coefplot_map <- post_log_2 %>% 
  select(contains("b_group")) %>% 
  set_names("1998 Gulmi", "2008 Gulmi",
            "1998 Arghakhanchi", "2008 Arghakhanchi") %>% 
  pivot_longer(everything()) %>% 
  mutate(
    work_hours = exp(value),
    treatment = factor(name, levels = names),
    low_conflict = ifelse( grepl("Gulmi", treatment), 
                           "Low Conflict","High Conflict")
  ) %>% 
  
  ggplot(aes(x = treatment, y = work_hours)) +
  stat_pointinterval(
    aes(color = low_conflict),
    .width = .95,
    linewidth = 5,
    point_size = 5
  ) +
  scale_color_manual(
    values = c("Low Conflict" = "seagreen", "High Conflict" = "red3"),
    name = ""
  )+
  labs( y = "", x = "", subtitle = "Work Hours")+
  theme_minimal(base_size = 18)+
            theme(panel.grid = element_blank(),
                  legend.position = "bottom")
  
ggsave("Analysis files/coefplot_map.jpg", plot = coefplot_map,
       width = 35, height = 20, units = c("cm"), bg = "white")

```

Overall DiD Contrast for Work Hours.

```{r}
post_log_2 %>% 
  select(contains("b_group")) %>% 
  mutate(did_r = (b_group4 - b_group2) - (b_group3 - b_group1)) %>% 
  mutate(
    did_a = (exp(b_group4) - exp(b_group2)) -
      (exp(b_group3) - exp(b_group1))
  ) %>% pull(did_a) %>% 
  mean_qi()
```

#### Coefficient Plots for model 2, for the hurdle part.

```{r}
coefplot_map_hu <- post_log_2 %>% 
  select(contains("b_hu")) %>% 
  set_names("1998 Gulmi", "2008 Gulmi",
            "1998 Arghakhanchi", "2008 Arghakhanchi") %>% 
  pivot_longer(everything()) %>% 
  mutate(
    probability = inv_logit_scaled(value),
    treatment = factor(name, levels = names),
    low_conflict = ifelse( grepl("Gulmi", treatment), 
                           "Low Conflict","High Conflict")
  ) %>% 
  
  ggplot(aes(x = treatment, y = probability)) +
  stat_pointinterval(
    aes(color = low_conflict),
    .width = .95,
    point_size = 5,
    linewidth = 5
  ) +
  scale_color_manual(
    values = c("Low Conflict" = "seagreen", "High Conflict" = "red3"),
    name = ""
  )+
  labs( y = "", x = "", subtitle = "Probability of zero hours worked")+
  theme_minimal(base_size = 18)+
            theme(panel.grid = element_blank(),
                  legend.position = "bottom")

ggsave("Analysis files/coefplot_map_hu.jpg", plot = coefplot_map_hu,
       width = 35, height = 20, units = c("cm"), bg = "white")

  
```


Overall Contrast for seeing zero hours worked.

```{r}
post_log_2 %>% 
  select(contains("b_hu")) %>% 
  mutate(did_r = (b_hu_group4 - b_hu_group2) - (b_hu_group3 - b_hu_group1)) %>% 
  mutate(
    did_a = (inv_logit_scaled(b_hu_group4) - inv_logit_scaled(b_hu_group2)) -
      (inv_logit_scaled(b_hu_group3) - inv_logit_scaled(b_hu_group1))
  ) %>% pull(did_a) %>% 
  mean_qi()

```
h



