---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Libraries

```{r}
library(tidyverse)
library(brms)
library(haven)
```

# Making Datasets ready for cleaning and analysis.

## Merge Household and Individual Level Data for NLFS 1.

```{r} 
# Read the dataset.

nlfs1_h <- read_dta("Data/nlfs1_household.dta")
nlfs1_i <- read_dta("Data/nlfs1_individual.dta")

# Merge 1:m using psuhhno (PSU and household number). The resulting dataset must ideally have 67,088 observations.

nlfs1_i_m <- left_join(nlfs1_i, nlfs1_h, by = c("psuhhno"))
d1 <- nlfs1_i_m
```

## Merge Household and Individual Level Data for NLFS 2

```{r}
# Read the dataset.

nlfs2_h <- read_dta("Data/nlfs2_household.dta")
nlfs2_i <- read_dta("Data/nlfs2_individual.dta")

# Merge the datasets such that there are ideally 76,028 observations from the individual dataset.

nlfs2_i_m <- left_join(nlfs2_i, nlfs2_h, by = c("psu", "hhid"))
d2 <- nlfs2_i_m
```

# Clean Datasets.

## Clean and make NLFS 1 dataset ready for analysis:

### Renaming some important variables.

```{r}
d1 <- d1 %>% rename(
  sex = q01,
  age = q02,
  hhsize = tothhmem.x,
  marital_status = q04,
  ethnicity = ethnicty.x,
)

# Note: var.x and var.y in this context are the same. R just likes to keep both during merge if the column name is the same.

# One can check this using all.equal(d1$ethnicty.x, d1$ethnicty.y)
```


### Create overall household variables.

```{r}
d1 <- d1 %>% mutate(
  # 1 is married, 0 is everything else
  marital_status = ifelse(marital_status !=2 | is.na(marital_status),
                          0, 1), 
  sex = if_else(sex == 2, 0, 1), # 1 is male
  nlfs_year = 1998,
  urbrur = if_else(urbrural.x %in% c(1, 2), 1, 0 ), # 1 is urban
  perma_resident = NA,
  district_name = as.character(as_factor(district.x)),
  district_abbrev = str_sub(str_to_lower(district_name), 1, 4),
  hindu = if_else(religion.x == 1, 1, 0),
  brahmin_chhetri = if_else(ethnicity %in% c(1, 2), 1, 0)
)

# Make district_abbrev same for later use.

d1 <- d1 %>% mutate(
  district_abbrev = case_when(
    district_name == "Dhankuta" ~ "dhak",
    district_name == "Dadheldh" ~ "dade",
    district_name == "Makawanp" ~ "makw",
    district_name == "Sindhupa" ~ "sinp",
    district_name == "Tehrahu" ~ "terh",
    TRUE ~ district_abbrev
  )
)

```

### Work Hours related variables.

Reminder: Some NAs are turned into 0, which means that if a person hasn't worked in a milling industry, it is coded as NA in the dataset, which implies he/she did 0 hours of work there. 

Reminder : Work Hours and many other activities are capped at 84 because I assume values higher than 12 hours * 7 days, are highly implausible, given a person also has to sleep and do all kinds of stuff. 

```{r}
# Wage Hours.

d1 <- d1 %>% mutate(
  # NAs are people who did not do any wage-related work.
  # NAs are coded as 0 hours of wage related work
  
  # If one wants to see suppose mean(wage_hours| worked a wage job),
  # filter the sample to only those who had more than 0 hours wage job. 
  wage_hours = ifelse(is.na(q16a), 0, ifelse(q16a > 84, 84, q16a) )
)


# Self Employment Hours
d1 <- d1 %>% mutate(
  # NAs in any one of the columns are treated as 0. 
  # If all columns are NAs, the sum is 0. 
  rs_selfemp = rowSums(select(., q16b:q16i), na.rm =T),
  selfemp_hours = if_else(rs_selfemp > 84, 84, rs_selfemp)
)

# Self Employment Hours (outside)
d1 <- d1 %>% mutate(
    rs_selfemp_o = rowSums(select(., q16b:q16f), na.rm =T),
    selfemp_hours_outside = if_else(rs_selfemp_o > 84, 84, rs_selfemp_o)
)

# Work Hours (overall, inside, and outside)

d1 <- d1 %>% mutate(
  rs_workhours = rowSums(select(., q16a:q16i), na.rm =T),
  rs_workhours_o = rowSums(select(., q16a:q16f), na.rm =T),
  rs_workhours_i = rowSums(select(., q16g:q16i), na.rm =T),
  
  
  work_hours = if_else(rs_workhours > 84, 84, rs_workhours),
  work_hours_outside = if_else(rs_workhours_o > 84, 84, rs_workhours_o),
  work_hours_inside = if_else(rs_workhours_i > 84, 84, rs_workhours_i)
)


# Non Work Hours
d1 <- d1 %>% mutate(
  nonwork_hours = rowSums(select(., q17a:q17g), na.rm = T)
)

# Total Hours (both outside `Work` as well as inside stuff.)

d1 <- d1 %>% mutate(
  rs_total = rowSums(select(., work_hours, nonwork_hours), na.rm = T),
  total_hours = if_else(rs_total > 110, 110, rs_total)
)
```


### Employed and Unemployed Status related variables.

```{r}
d1 <- d1 %>% mutate(
  # For ages 15-59, there are no NAs. 
  currently_emp = ifelse(
    work_hours !=0 | (q18 == 1 & (q19 == 1 | q20 == 1)),
    1, 0
  ),
  
  
  currently_emp_out = ifelse(
    work_hours_outside !=0 | ((q18 == 1 & (q19 == 1 | q20 == 1)) %in% TRUE),
    1, 0
  ),
  
  # Missing values are children
  currently_selfemp_out = ifelse(
    selfemp_hours_outside !=0 | 
      ((q18 == 1 & (q19 == 1 | q20 == 1)) %in% TRUE),
    1, 0
  ),
  
  # NAs are people who have not pursued wage jobs. 
  currently_emp_wage = ifelse(
    wage_hours !=0 | ((q18 == 1 & (q19 == 1 | q20 == 1)) %in% TRUE),
    1, 0
  ),
  
  # Think of the NAs for these 
  currently_unemp = ifelse(
    ((q46 == 1 | (q46 == 2 & q51 !=5)) %in% TRUE),
    1, 0
  ),
  
  currently_underemp = ifelse(
    q16 < 40 & (q37 %in% c(1:6)),
    1, 0
  ),
  
  currently_active = ifelse(
    currently_emp == 1 | currently_unemp == 1, 
    1, 0
  ),
  
  # If NA in currently active, then they are considered currently inactive
  currently_inactive = ifelse(
    currently_active != 1 | is.na(currently_active), 1, 0
  )
)

```

### Usually Active Statuses:

```{r}
d1 <- d1 %>% mutate(
  # Again, the NAs are children under the age of 5
  usually_active = ifelse(
    q58 >=180, 1, 0
  ),
  
  # Again, the NAs are children aged 5 or less.
  usually_inactive = ifelse(
    usually_active == 1, 0, 1
  ),
  
  usually_emp = ifelse(
    usually_active == 1 & (q54 > q55),
    1, 0
  ),
  
  usually_unemp = ifelse(
    usually_active == 1 & (q55 >= q54), 
    1, 0
  )
)
```

### Educational Metrics:

```{r}
d1 <- d1 %>% mutate(
  can_read = ifelse(q08 == 1, 1, 0),
  # the can_write is not asked if the person can't read. We can assume thus
  # that if can_read == 0 than can_write is also 0
  can_write = ifelse(q09 !=1 | q08 !=1, 0, 1),
  current_attend = ifelse(q10 == 1, 1, 0), 
  
  # the ever attend question is not asked to those who answered YES to 
  # currently_attend. Therefore there are 4620 NAs. 
  ever_attend = ifelse(q11 == 1, 1, 0),
  
  # Just a variable to records q12 == 16 i.e. edu others. 
  edu_others = ifelse(q12 == 16, 1, 0),
  ever_school = ifelse(q10 == 1 | q11 == 1, 1, 0),
  
  # This metric is only applicable for those who have ever attended school.
  # Therefore if ever_school == 0, years_of_edu is NA
  years_of_edu  = case_when(
    q12 %in% c(16, 99) ~ NA,
    q12 == 13 ~ 16,
    q12 %in% c(14, 15) ~ 18,
    TRUE ~ q12
  ),
  
  # Those who have never attended school will be classified as 0.
  # This means that edu_others also counts as 0 because this only looks at 
  # formal education
  years_of_edu_all = ifelse(is.na(years_of_edu),0, years_of_edu)
  
)
```

## Limiting the sample to people aged 15 to 59.

```{r}
d1 <- d1 %>% filter(age %in% c(15:59))
```


## Select All the variables that are needed:

```{r}
d1_select <- d1 %>% select(nlfs_year, psu, age, sex, hhsize, urbrur,
                           marital_status, hindu, brahmin_chhetri,
                           district_name, district_abbrev, 
                           wage_hours, selfemp_hours, selfemp_hours_outside,
                           work_hours, work_hours_outside, nonwork_hours, total_hours,
                           currently_emp, currently_emp_out, 
                           currently_selfemp_out, currently_emp_wage,
                           currently_unemp, currently_underemp, usually_emp, 
                           usually_unemp, currently_active, currently_inactive,
                           usually_active, usually_inactive, 
                           can_read, can_write, current_attend, 
                           ever_attend, years_of_edu, ever_school, years_of_edu_all
                           )

write_csv(d1_select, "Data/nlfs1_kept_individual.csv" )
```


## Clean NLFS 2 and make it ready for analysis.


### Overall Household Variables:
```{r}


d2 <- d2 %>% rename(
  age = q10,
  hhsize = totmemb,
)

d2 <- d2 %>% mutate(
  urbrur = ifelse(urbrur == 2, 0, 1), # urban is 1 and rural is 0
)

d2 <- d2 %>% mutate(
  nlfs_year = 2008,
  sex = ifelse(q09 == 2, 0, 1), # male is 1. 
  marital_status = ifelse(q13 == 2, 1, 0), # If married then 1, everything else 0
  hindu = ifelse(religion == 1, 1, 0),
  brahmin_chhetri = ifelse(q11 %in% c(1, 2), 1, 0),
  district_name = as.character(as_factor(dist)),
  district_abbrev = str_sub(str_to_lower(district_name), 1, 4)
)

# On permanent residency.

d2 <- d2 %>% mutate(
    not_perma_resident = ifelse(
      (q17 == 2 & q21 == 2 & q24 < 12) | (q17 == 1 & q21 == 2 & q24 < 12),
      1, 0
    ),
    perma_resident = ifelse(not_perma_resident == 1, 0, 1)
)


# Making district names and abbrevs similar for merging later on.
d2 <- d2 %>% mutate(
  district_abbrev = case_when(
    district_name == "Dhankuta" ~ "dhak",
    district_name == "Sindhupalchok" ~ "sinp",
    TRUE ~ district_abbrev
  )
)


```

### Work Hours related variables:

```{r}
d2 <- d2 %>% mutate(
  # Wage Hours
  # 0 here means either they didnot work in wage jobs, or even if they did,
  # they worked 0 hours in the last week. 
  rs_wagehours = rowSums(select(., q36a:q36b), na.rm =T),
  wage_hours = ifelse(rs_wagehours > 84, 84, rs_wagehours),
  
  # Self Employment Hours (Total)
  rs_selfemp = rowSums(select(., q36c:q36j), na.rm = T),
  selfemp_hours = ifelse(rs_selfemp > 84, 84, rs_selfemp),
  
  # Self Employment Hours (Outside)
  rs_selfemp_o = rowSums(select(., q36c:q36g), na.rm = T),
  selfemp_hours_outside = ifelse(rs_selfemp_o > 84, 84, rs_selfemp_o),
  
  # Total Work Hours
  rs_workhours = rowSums(select(., q36a:q36j), na.rm = T),
  work_hours = ifelse(rs_workhours > 84, 84, rs_workhours),
  
  # Work Hours Outside
  rs_workhours_o = rowSums(select(., q36a:q36g), na.rm = T),
  work_hours_outside = ifelse(rs_workhours_o > 84, 84, rs_workhours_o),
  
  # Work Hours Inside (includes fetching water, collecting firewood,
  # and other home-based work activities. )
  rs_workhours_i = rowSums(select(., q36h:q36j), na.rm = T),
  work_hours_inside = ifelse(rs_workhours_i > 84, 84, rs_workhours_i),
  
  # Non Work Hours:
  nonwork_hours = rowSums(select(., q37a:q37g), na.rm = T),
  
  
  
)

d2 <- d2 %>% mutate(
  # Total Hours
  rs_total = rowSums(select(., work_hours, nonwork_hours), na.rm = T),

  total_hours = ifelse(
    rs_total > 110, 110, rs_total
  )
)
```

### Employed and Unemployed Statuses:

Reminder : suppose if currently_emp_wage has like 30,000 FALSE (0) and 10,000 TRUE (1), it means those people did not have a wage job.  They may still be currently employed (TRUE)

NA is turned to 0 in these occasions to show that. 

```{r}
d2 <- d2 %>% mutate(
  # No NAs after filtering out age and not real household members. 
  currently_emp = ifelse(
    (work_hours > 0  | (q38 == 1 & (q39 == 1  | q40 == 1))),
    1, 0
  ),
  
  
  currently_emp_out = ifelse(
    (work_hours_outside > 0  | 
       ((q38 == 1 & (q39 == 1  | q40 == 1))) %in% TRUE ),
    1, 0
  ),
  
  
  currently_selfemp_out = ifelse(
    (selfemp_hours_outside > 0  | 
       ((q38 == 1 & (q39 == 1  | q40 == 1))) %in% TRUE  ) ,
    1, 0
  ),
  
  currently_emp_wage = ifelse(
    (wage_hours > 0  | 
       ((q38 == 1 & (q39 == 1  | q40 == 1))) %in% TRUE  ), 
    1, 0
  ),
  
  # Think of the NAs for these, there are currently a lot of NAs. It has
  # probably got sth to do with the fact of how R handles logical NAs. 
  # For a lot of the people, question number 77 is Not applicable, who in
  # reality must be casted as 0. 
  currently_unemp = ifelse(
    (q77 == 1 | 
       (q77 == 2 & q82 != 5)) %in% TRUE,
    1, 0
  ),
  
  # No NAs here:
  currently_underemp = ifelse(
    work_hours < 40 & q68 %in% c(1:6),
    1, 0
  ),
  
  
  currently_active = ifelse(
    currently_emp == 1 | currently_unemp == 1,
    1, 0
  ),
  
  
  currently_inactive = ifelse(
    currently_active == 1, 0, 1
  )
)

```


### Usually Active Status Variables. 

```{r}
d2 <- d2 %>% mutate(
  # 1 if people worked for all 12 months or if not, active months greater
  # than inactive months.
    
  usually_active = ifelse(
    (q88 >= q87) | (q85 == 12),
    1, 0
  ),
  
  usually_inactive = ifelse(
    usually_active == 1,
    1, 0
  ),
  
  
  usually_emp = ifelse(
    (usually_active == 1 & (q85 == 12 | q85>q86)),
    1, 0
  ),
  
  
  usually_unemp = ifelse(
    (usually_active == 1 & (q85 !=12 & q86 >= q85)),
    1, 0
  )
)
```

### Educational Metrics:

```{r}
d2 <- d2 %>% mutate(
  can_read = ifelse(q26 == 1, 1, 0),
  
  # People who can't read are not asked can_write question.
  # If can_read == 0, then can_write should also be 0 and not NA
  can_write = ifelse(q27 == 2 | q26 == 2, 0, 1),

  current_attend = ifelse(q28 == 1, 1, 0),
  # If current attend is TRUE, the question is not asked for ever attend.
  ever_attend = ifelse(q29 == 1, 1, 0),
  ever_school = ifelse((q28 == 1 | q29 == 1) %in% TRUE, 1, 0),
  
  # The missing values are people who have never attended school
  years_of_edu = case_when(
    # literate and illiterate is useless info now even info on can_read and
    # can write.
    q30 %in% c(16, 17) ~ 0,
    q30 == 11 ~ 11.5, # 11 in this dataset means 18 months diploma
    q30 == 13 ~ 16,
    q30 %in% c(14, 15) ~ 18,
    TRUE ~ q30
  ),
  
  # Only looks at formal education. Literate (non Formal education) and Illiterate will be classified as 0 years of formal schooling. 
  years_of_edu_all = ifelse(
    ever_school == 0, 0, years_of_edu
  )
  
)
```

## Filter the sample to include people aged 15-59 and only those who qualify as members of the household.



```{r}
d2 <- d2 %>% filter(age %in% c(15:59) & q16 == 1)
```


## Select all the variables that are needed:

```{r}
d2_select <- d2 %>% select(nlfs_year, psu, age, sex, hhsize, urbrur,
                           marital_status, hindu, brahmin_chhetri,
                           district_name, district_abbrev, 
                           wage_hours, selfemp_hours, selfemp_hours_outside,
                           work_hours, work_hours_outside, 
                           nonwork_hours, total_hours,
                           currently_emp, currently_emp_out, 
                           currently_selfemp_out, currently_emp_wage,
                           currently_unemp, currently_underemp, usually_emp,
                           usually_unemp, 
                           currently_active, currently_inactive,
                           usually_active, usually_inactive, 
                           can_read, can_write, current_attend, 
                           ever_attend, years_of_edu, 
                           ever_school, years_of_edu_all
                           )

write_csv(d2_select, "Data/nlfs2_kept_individual.csv")

```

# Append the two nlfs datasets.
```{r}

d1_csv <- read_csv("Data/nlfs1_kept_individual.csv")
d2_csv <- read_csv("Data/nlfs2_kept_individual.csv")
nlfs <- bind_rows(d1_csv, d2_csv)

```



# Clean the Conflict Dataset. 

```{r}
# Read the dataset.
c <- read_csv("Data/conflict.csv")

# Filter only those with location precision of 1, 2, or 3 and
# between the years 1996 to 2006.

c <- c %>% filter(where_prec %in% c(1, 2, 3) & 
                    (year %in% c(1996:2006)) | 
                      (year %in% c(2007, 2008) & 
                       (side_a == "CPN-M" | side_b == "CPN-M"))
                  )

# Cleaning up districts

c <- c %>% mutate(
  district_name = str_remove(adm_2, " district"),
  low_est = as.numeric(str_remove(low_est, ","))
)



# Counting deaths for each year for each district. 
c_year <- c %>% count(district_name, year) %>% 
  pivot_wider(
    names_from = year,
    values_from = n,
    names_prefix = "deaths_",
    values_fill = 0
  )

# grouping and summing a lot of variables by district.

c_others <- c %>% group_by(district_name) %>% 
  summarize(
    across(deaths_a:low_est, \(x) sum(x, na.rm = T))
  )

c_collapsed <- left_join(c_year, c_others, by = c("district_name"))

c_collapsed <- c_collapsed %>% mutate(
  district_abbrev = str_sub(str_to_lower(district_name), 1, 4)
)
  


```

# Identify Treatment and Control Districts. 

## Filter districts which already had deaths before the end of 1998. 
```{r}

c_collapsed <- c_collapsed %>% 
  mutate(
    deaths_until_98 = 
      rowSums(select(., deaths_1996, deaths_1997, deaths_1998), na.rm = T),
      district = str_to_lower(district_name)
  )

# Making district codes similar for merge. 
c_collapsed <- c_collapsed %>% mutate(
  district_abbrev = case_when(
    district_name == "Dhankuta" ~  "dhak",
    district_name == "Sindhupalchowk"~  "sinp",
    district_name == "Parvat" ~ "parb",
    district_name == "Makawanpur" ~ "makw",
    TRUE ~ district_abbrev
  )
)

# Load the population census data to normalize deaths by population.
popn_01 <- read_csv("Data/nepal_popn_2001.csv")
popn_01 <- popn_01 %>% mutate(
  district_abbrev = str_sub(str_to_lower(district), 1, 4)
)

# Making district codes similar for merge. 
popn_01 <- popn_01 %>% mutate(
  district_abbrev = case_when(
    district == "dhankuta" ~  "dhak",
    district == "sindhupalchok"~  "sinp",
    TRUE ~ district_abbrev
  )
)

# Merge with c_collapsed.

c_collapsed_2 <- left_join(c_collapsed, popn_01, by = c("district_abbrev"))
c_small <- c_collapsed_2 %>% filter(deaths_until_98 == 0)

```


## Assigning Treatment and Control. 

```{r}
# Conflict Deaths per 10,000 people according to 2001 Census.

c_small <- c_small %>% mutate(
  cd_per_10000 = round((best_est/ popn_2001) * 1e4,3),
)

# Treatment assignment based on the 75th percentile. 
c_small <- c_small %>% mutate(
  treatment_s = ifelse(cd_per_10000 > quantile(cd_per_10000, 0.75), 1, 0)
)

```


# Merge the dataset with nlfs appended dataset. 

```{r}
c_merged <- left_join(c_small, nlfs, by = c("district_abbrev"))
```

