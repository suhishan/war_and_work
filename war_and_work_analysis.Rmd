---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
library(DRDID)
library(stargazer)
library(modelsummary)
library(xtable)
library(tidybayes)
library(tidyverse)

theme_set(theme_minimal()+
            theme(panel.grid = element_blank()))
```

# Preliminary Observations

## Difference in E[D = d_h] & E[D = d_l]
```{r}

c_small %>% group_by(treatment_s) %>% 
  summarize(mean = round( mean(cd_per_10000), 2))

```

## Sample Size Classification:

```{r}
c_merged %>% count(nlfs_year, treatment_s)
```


## First stage lm regression to see how many conflict deaths higher do treatment districts face than non conflict ones.


```{r}
c_small <- c_small %>% mutate(
    cd_per_10000_std = rethinking::standardize(cd_per_10000)
  )

m3 <- lm(cd_per_10000_std  ~ treatment_s, data = c_small); summary(m3)

# Display/Output the results in a tex file.
stargazer(m3,  type = "latex", star.cutoffs = NA,
          keep.stat = c("n", "rsq","adj.rsq"),
          covariate.labels = c("Treatment (1/0)"),
          dep.var.labels = c("Conflict Deaths per 10,000 population (std)"),
          notes = "(std) represents standardized variables",
          out = "Analysis files/small_sample_reg.tex",
          title = "Conflict Deaths per 10,000 population regressed on Treatment Status",
          notes.append =F)

```

Conflict Deaths per 10,000 people is 1.8 Standard deviations higher in High conflict-afflicted areas than low conflict-afflicted areas. 

## Make the dataset cleaner and organized for analysis.

```{r}
c_merged <- c_merged %>% mutate(
  id = as.numeric(1:n()),
  post = ifelse(nlfs_year == 2008, 1, 0),
  work_hours_outside_std = rethinking::standardize(work_hours_outside),
  selfemp_hours_outside_std =
    rethinking::standardize(selfemp_hours_outside),
  conflict_deaths = best_est,
  poverty_rate = pov_rate * 100
)
```

# Summary Statistics:

```{r}
a <- c_merged %>%
  select(usually_emp,currently_emp_out,currently_selfemp_out,
         work_hours_outside, selfemp_hours_outside, conflict_deaths,
         cd_per_10000, age, ever_attend,years_of_edu, years_of_edu_all,
         hindu, brahmin_chhetri, sex, marital_status, hhsize, urbrur)

datasummary_skim(a ,output = "html", fmt = 2)

```

## Covariate Difference Table for NLFS 1 (1998)

```{r}
c_merged_98 <- c_merged %>% filter(nlfs_year == 1998 & !is.na(poverty_rate))
c_merged <- c_merged %>% filter(!is.na(poverty_rate))

# Unfortunately we do not have Rasuwa's Poverty Rate.

```


```{r}
#function to calculate normalized difference
norm_difference <- function(t, x) {
  mean_t <-  mean(x[t == 1], na.rm = T)
  mean_c <-  mean(x[t == 0], na.rm = T)
  sd_t <-  sd(x[t == 1],na.rm =T)
  sd_c <- sd(x[t==0],na.rm = T )
  norm_diff = (mean_t - mean_c) / sqrt(0.5 * (sd_t^2 + sd_c^2))
  return (round(norm_diff, digits = 4))
}

table_norm <- c_merged_98 %>% 
  select(age, years_of_edu_all, years_of_edu, hindu,
         brahmin_chhetri, sex, marital_status,
         treatment_s, hhsize, urbrur,
         ever_school) %>% 
  summarize(across(
    .cols = -treatment_s,
    .fns = list(
      norm_diff = ~norm_difference(treatment_s, .x),
      mean_t  = ~ mean(.x[treatment_s == 1], na.rm = T),
      mean_c = ~mean(.x[treatment_s == 0], na.rm = T)),
    .names = "{fn}_{.col}"
  )) %>% 

 pivot_longer(
    cols = everything(),
    names_to = "stat_var", values_to = "value"
  ) %>% 
  extract(stat_var, into = c("stat", "variable"),
          regex = "(norm_diff|mean_t|mean_c)_(.+)") %>% 
  pivot_wider(
    names_from = stat, values_from = value
  )


```

### Output into a tex file.

```{r}
pretty_names <- c(
  age = "Age",
  years_of_edu_all = "Years of Education (All)",
  years_of_edu = "Years of Education (If attended school)",
  hindu = "Hindu (1/0)",
  brahmin_chhetri = "Brahmin/Chhetri(1/0)",
  sex = "Male",
  marital_status = "Married",
  hhsize = "Household Size",
  urbrur = "Urban",
  ever_school = "Ever Attended School"
)

table_norm_out <- table_norm %>% 
  mutate(
    variable = pretty_names[variable]
  ) %>% 
  rename(
    `Norm. Diff` = norm_diff,
    `Treated Mean` = mean_t,
    `Control Mean` = mean_c,
  ) %>% mutate(
    across(c(`Norm. Diff`, `Treated Mean`, `Control Mean`), ~ round(.x, 3))
  ) %>% 
  column_to_rownames("variable")

print(xtable(table_norm_out, caption = "Covariate Balance Statistics"), 
      type = "latex",
      file = "Analysis files/covariate_balance.tex",
      booktabs = T,
      )

table_norm_out

```


## Covariate Difference In Trends:

```{r}
t1 <- c_merged %>% 
  select(age, years_of_edu_all, years_of_edu, hindu,
         brahmin_chhetri, sex, marital_status,
         treatment_s, hhsize,post, urbrur,
         ever_school) %>% 
  group_by(treatment_s) %>% 
  summarize(
    across(
      .cols = -post,
      .fns = list(
        delta = ~ mean(.x[post == 1], na.rm = T) - mean(.x[post == 0], 
                                                        na.rm = T)),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop") %>% 
    pivot_longer(cols = -treatment_s, names_to = "variables",
                 values_to = "delta") %>% 
  pivot_wider(names_from = treatment_s, values_from = delta,
              names_prefix = "delta_")

t1
```


### Output it into a tex file.

```{r}
pretty_names_delta <- c(
  age_delta = "Age",
  years_of_edu_all_delta = "Years of Education (All)",
  years_of_edu_delta = "Years of Education (If attended school)",
  hindu_delta = "Hindu (1/0)",
  brahmin_chhetri_delta = "Brahmin/Chhetri(1/0)",
  sex_delta = "Male",
  marital_status_delta = "Married",
  hhsize_delta = "Household Size",
  urbrur_delta = "Urban",
  ever_school_delta = "Ever Attended School"
)

t1_out <- t1 %>% 
  mutate(variables = pretty_names_delta[variables]) %>% 
  rename(
    `Control trend` = delta_0,
    `Treatment trend` = delta_1,
  ) %>% column_to_rownames("variables") %>% 
  mutate(
    across(c(`Control trend`,`Treatment trend`), ~ round(.x, 3) )
  )


print(xtable(t1_out, caption = "Covariate Balance Statistics for trends/differences (2008 - 1998)"), 
      type = "latex",
      file = "Analysis files/covariate_balance_trends.tex",
      booktabs = T,
      )
t1_out

```

#### Difference in Poverty Rates (Headcount Ratio)
```{r}
c_small %>% group_by(treatment_s) %>% 
  summarize(mean(pov_rate, na.rm = T))
```


## Propensity Scores for IPW

```{r}
library(sandwich)
library(lmtest)

ps <- glm(treatment_s ~ hindu + brahmin_chhetri + 
          sex + poverty_rate + urbrur,
          data = c_merged_98, family = binomial(link = "logit") )

summary(ps)


cl_vcov <- vcovCL(ps, cluster = c_merged_98$psu, type = "HC1")
cl_test <- coeftest(ps, vcov. = cl_vcov); cl_test


coefs <- cl_test[, 1]
ses <- cl_test[, 2] # clustered standard errors. 

```

### Propensity Score Regression Output:

```{r}
stargazer(ps,
          se = list(ses),
          type = "latex",
          out = "Analysis files/propensity_score_reg.tex",
          title = "Propensity Score Regression on observed covariates (1998 NLFS)",
          dep.var.labels = "Treatment (high-conflict)",
          covariate.labels = c("Hindu", "Brahmin/Chhetri","Sex", "Poverty Rate","Urban"),
          digits = 3,
          #star.cutoffs = NA,
          
          notes = "Standard errors are psu-clustered",
          notes.append = F)

```


### Plot the propensity Scores:

```{r}
c_merged_98$pscore <- predict(ps, type = "response")

ps_small_sample <- c_merged_98 %>% 
  ggplot(aes(x = pscore, color = factor(treatment_s)))+
  geom_histogram(aes(y = after_stat(density)),alpha = 0.5,
                 position = "identity",
                 fill = "white",
                 bins = 40,
                 linewidth = 1.35)+
  scale_color_manual(values = c("blue","red"),
                     name = "Treatement",
                     labels = c("Low Conflict", "High Conflict")) +
  labs(
    x= "Propensity Score",
    y = "Density"
  ) + 
  theme_minimal()


# TODO: Output a picture:

ps_small_sample

ggsave("Analysis files/ps_overlap.jpg", plot = ps_small_sample,
       width = 25, height = 15, units = c("cm"), bg = "white")

```



# Doubly Robust DiD function:

## Model 1 (the standard normal model)

```{r}
dr <- function(v, d){
  a <- drdid(yname = v, tname = "post", idname = "id",
             dname = "treatment_s",
             xformla = ~ hindu + brahmin_chhetri + 
               urbrur + sex + poverty_rate,
             data = d, panel = FALSE, boot = F, nboot = 199)
  
  out =  round(data.frame(a[1:4]), 3)
  
  return (out)
  
}

# Outcome Variables.

vars <- c("usually_emp", "currently_emp_out",
          "currently_selfemp_out",
          "work_hours_outside", "work_hours_outside_std"
          ,"selfemp_hours_outside","selfemp_hours_outside_std")

output_dr <- function(vars, d) {
  b <- sapply(vars, dr, d)
  return (data.frame(t(b)))
}

```

## Model 1 : The conventional model.
```{r}

model_1 <- output_dr(vars, c_merged) %>% 
  rownames_to_column(var = "variables")

```

### Output Model 1 in a tex format.

```{r}
outcome_var_names <- c(
  usually_emp = "Usually Employed",
  currently_emp_out = "Currently Employed",
  currently_selfemp_out = "Currently Self-employed",
  work_hours_outside = "Work Hours",
  work_hours_outside_std = "Work Hours (std)",
  selfemp_hours_outside = "Self Employment Hours",
  selfemp_hours_outside_std = "Self Employment Hours (std)"
)

model_1_out <- model_1 %>% 
  mutate(variables = outcome_var_names[variables]) %>% 
  column_to_rownames("variables")


print(xtable(model_1_out, caption = "Doubly Robust DiD estimates of ATT"), 
      type = "latex",
      file = "Analysis files/model_1.tex",
      booktabs = T,
      )

```

### Draw Coefficient Plots.

#### Employed/Unemployed Statuses Coefficient Plots.

```{r}
# Coefficient Plots for the first three Bernoulli variables.

model_1_1 <- model_1_out[1:3, ]
model_1_1$Outcome <- c("Usually Employed",
                         "Currently Employed",
                         "Currently Self Employed")


coefplot_1_1 <- model_1_1 %>%
  ggplot(aes(x = as.numeric(ATT), y = as.factor(Outcome)))+
  geom_point(size = 3)+
  geom_errorbarh(aes(xmin = as.numeric(lci),
                     xmax = as.numeric(uci)),
                 height = 0.2,
                 col = "black",
                 linewidth = 1.1)+
  geom_vline(xintercept = 0, linetype = 2)+
  labs(x = "ATT", title = "Doubly Robust DiD Estimates",
       subtitle = "The coefficient plot shows 95% confidence intervals.",
       y = "")+
  theme_minimal(base_size = 18)

# Output the picture.
ggsave("Analysis files/coefplot_1_1.jpg", plot = coefplot_1_1,
       width = 25, height = 15, units = c("cm"), bg = "white")


```

#### Work Hours Coefficient Plots

```{r}
model_1_2 <- model_1_out[c(4, 6),]
model_1_2$Outcomes <- c("Work Hours", "Self Employment Hours")

coefplot_1_2 <- model_1_2 %>% 
  ggplot(aes(x = as.numeric(ATT), y = Outcomes))+
  geom_point(size = 3)+
  geom_errorbarh(aes(xmin = as.numeric(lci), xmax = as.numeric(uci)),
                 height = 0.2, color = "black", linewidth = 1.1)+
  geom_vline(xintercept = 0, linetype = 2) +
  labs(x = "ATT (hours)", y = "", 
       title = "Doubly Robust DiD Estimates",
       subtitle = "The coefficient plot shows 95% confidence intervals")+
  theme_minimal(base_size = 18) 


# Output the picture
ggsave("Analysis files/coefplot_1_2.jpg", plot = coefplot_1_2,
       width = 25, height = 15, units = c("cm"), bg = "white")

```


## Model 2 (the migration model)
In this model, only those who are permanent residents in 2008 are taken into consideration i.e. people born in their current place or people who moved before the Maoist Insurgency.

```{r}
c_merged_p <- c_merged %>% filter(post == 0 |
                                  (post == 1 & perma_resident == 1))

model_2 <- output_dr(vars, c_merged_p) %>% 
  rownames_to_column(var = "variables")

model_2

```


### Output the migration model.

```{r}
model_2_out <- model_2 %>% 
  mutate(variables = outcome_var_names[variables]) %>% 
  column_to_rownames("variables")

print(xtable(model_2_out,
             caption = "Doubly Robust DiD estimates
             of ATT accounting for migration"), 
      type = "latex",
      file = "Analysis files/model_2.tex",
      booktabs = T,
      )

```

####  Bernoulli Employed Type Coefficient Plots for Migration model

```{r}
# Coefficient Plots for the first three Bernoulli variables.

model_2_1 <- model_2_out[1:3, ]
model_2_1$Outcome <- c("Usually Employed",
                         "Currently Employed",
                         "Currently Self Employed")


coefplot_2_1 <- model_2_1 %>%
  ggplot(aes(x = as.numeric(ATT), y = as.factor(Outcome)))+
  geom_point(size = 3)+
  geom_errorbarh(aes(xmin = as.numeric(lci),
                     xmax = as.numeric(uci)),
                 height = 0.2,
                 col = "black",
                 linewidth = 1.1)+
  geom_vline(xintercept = 0, linetype = 2)+
  labs(x = "ATT", title = "Doubly Robust DiD Estimates (Controlling for Migration)",
       subtitle = "The coefficient plot shows 95% confidence intervals.",
       y = "")+
  theme_minimal(base_size = 18)

# Output the picture.
ggsave("Analysis files/coefplot_2_1.jpg", plot = coefplot_2_1,
       width = 30, height = 15, units = c("cm"), bg = "white")


```

#### Work Hour Coefficient Plots (Controlling for migration)

```{r}
model_2_2 <- model_2_out[c(4, 6),]
model_2_2$Outcomes <- c("Work Hours", "Self Employment Hours")

coefplot_2_2 <- model_2_2 %>% 
  ggplot(aes(x = as.numeric(ATT), y = Outcomes))+
  geom_point(size = 3)+
  geom_errorbarh(aes(xmin = as.numeric(lci), xmax = as.numeric(uci)),
                 height = 0.2, color = "black", linewidth = 1.1)+
  geom_vline(xintercept = 0, linetype = 2) +
  labs(x = "ATT (hours)", y = "", 
       title = "Doubly Robust DiD Estimates (Controlling for Migration)",
       subtitle = "The coefficient plot shows 95% confidence intervals")+
  theme_minimal(base_size = 18) 


# Output the picture
ggsave("Analysis files/coefplot_2_2.jpg", plot = coefplot_2_2,
       width = 30, height = 15, units = c("cm"), bg = "white")


```

